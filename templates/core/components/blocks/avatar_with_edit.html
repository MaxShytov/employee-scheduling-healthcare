{% load i18n %}
{% load static %}

{% comment %}
Avatar Header Block with Edit Menu
Interactive avatar with HubSpot-style edit functionality:
- Hover: Shows darkened overlay with edit icon
- Click: Opens dropdown menu with Upload/Change/Remove commands
- AJAX instant upload/delete

Props from block dict:
- avatar_url: Current avatar image URL
- avatar_initials: Fallback initials if no image
- name: Display name
- subtitle: Job title or description
- badge: Status badge {text, class}
- upload_url: AJAX endpoint for image upload
- delete_url: AJAX endpoint for image deletion
{% endcomment %}

<div class="text-center mb-3">
    {# Avatar with edit overlay and menu - wrapped in relative container #}
    <div class="position-relative d-inline-block">
        <div class="position-relative d-inline-block" style="cursor: pointer;" id="avatar-container">
            {# Avatar Image #}
            {% if block.avatar_url %}
                <img src="{{ block.avatar_url }}"
                     alt="{{ block.name }}"
                     class="rounded-circle border border-3 border-white shadow"
                     style="width: 120px; height: 120px; object-fit: cover;"
                     id="avatar-image">
            {% else %}
                <div class="rounded-circle border border-3 border-white shadow d-flex align-items-center justify-content-center"
                     style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 42px; font-weight: 600; color: white;"
                     id="avatar-initials">
                    {{ block.avatar_initials }}
                </div>
            {% endif %}

            {# Hover overlay with edit icon #}
            <div class="position-absolute top-0 start-0 w-100 h-100 rounded-circle d-flex align-items-center justify-content-center"
                 style="background: rgba(0,0,0,0); transition: background 0.3s ease;"
                 id="avatar-overlay">
                <span class="material-icons text-white" style="font-size: 36px; opacity: 0; transition: opacity 0.3s ease;" id="edit-icon">edit</span>
            </div>
        </div>

        {# Dropdown menu (initially hidden) - positioned right below avatar #}
        <div class="dropdown-menu shadow-lg" id="avatar-menu"
             style="display: none; position: absolute; top: 130px; left: 50%; transform: translateX(-50%); z-index: 1050; min-width: 200px;">
            {% if block.avatar_url %}
                <a class="dropdown-item" href="#" id="change-avatar">
                    <span class="material-icons align-middle me-2" style="font-size: 18px;">upload</span>
                    {% trans "Change Image" %}
                </a>
                <a class="dropdown-item" href="{{ block.avatar_url }}" target="_blank">
                    <span class="material-icons align-middle me-2" style="font-size: 18px;">visibility</span>
                    {% trans "Preview" %}
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="#" id="delete-avatar">
                    <span class="material-icons align-middle me-2" style="font-size: 18px;">delete</span>
                    {% trans "Remove image" %}
                </a>
            {% else %}
                <a class="dropdown-item" href="#" id="upload-avatar">
                    <span class="material-icons align-middle me-2" style="font-size: 18px;">upload</span>
                    {% trans "Upload Image" %}
                </a>
            {% endif %}
        </div>
    </div>

    {# Hidden file input #}
    <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">

    {# Name and subtitle #}
    <h4 class="mt-3 mb-1">{{ block.name }}</h4>
    <p class="text-muted mb-2">{{ block.subtitle }}</p>

    {# Status badge #}
    {% if block.badge %}
        <span class="badge {{ block.badge.class }} px-3 py-2">{{ block.badge.text }}</span>
    {% endif %}
</div>

{# AJAX functionality #}
{% if block.upload_url %}
<script>
(function() {
    const container = document.getElementById('avatar-container');
    const overlay = document.getElementById('avatar-overlay');
    const editIcon = document.getElementById('edit-icon');
    const menu = document.getElementById('avatar-menu');
    const fileInput = document.getElementById('avatar-file-input');
    const avatarImage = document.getElementById('avatar-image');
    const avatarInitials = document.getElementById('avatar-initials');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

    // Hover effect
    container.addEventListener('mouseenter', function() {
        overlay.style.background = 'rgba(0,0,0,0.5)';
        editIcon.style.opacity = '1';
    });

    container.addEventListener('mouseleave', function() {
        overlay.style.background = 'rgba(0,0,0,0)';
        editIcon.style.opacity = '0';
    });

    // Click to show/hide menu
    container.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Toggle menu visibility
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            menu.style.display = 'block';
        }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        if (!menu.contains(e.target) && !container.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    // Upload/Change button
    const uploadBtn = document.getElementById('upload-avatar') || document.getElementById('change-avatar');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            menu.style.display = 'none';
            fileInput.click();
        });
    }

    // Delete button
    const deleteBtn = document.getElementById('delete-avatar');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            menu.style.display = 'none';

            if (!confirm('{% trans "Are you sure you want to delete this image?" %}')) {
                return;
            }

            // Delete via AJAX
            fetch('{{ block.delete_url }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show updated avatar
                    window.location.reload();
                } else {
                    alert('{% trans "Error deleting file" %}: ' + (data.error || '{% trans "Unknown error" %}'));
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert('{% trans "Error deleting file" %}');
            });
        });
    }

    // File selection handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('{% trans "Please select an image file" %}');
            return;
        }

        // Prepare form data
        const formData = new FormData();
        formData.append('profile_picture', file);

        // Upload via AJAX
        fetch('{{ block.upload_url }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload page to show updated avatar
                window.location.reload();
            } else {
                alert('{% trans "Error uploading file" %}: ' + (data.error || '{% trans "Unknown error" %}'));
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('{% trans "Error uploading file" %}');
        });
    });
})();
</script>
{% endif %}
